<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šæ–°èäººç¾¤ç¾¤ä¸‰ä»£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root {
            --primary-color: #0d9488; /* Teal - A fresh, flagship color */
            --secondary-color: #f59e0b; /* Amber - High contrast accent */
            --background-light: #f4f6f9;
            --text-dark: #1f2937;
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            min-height: 100vh;
        }
        .tab-button {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 700;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            color: #4b5563;
            font-size: 1rem;
            white-space: nowrap;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: #ecfdf5; /* Light green-teal background */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- æ¨™é¡Œæ¨£å¼ --- */
        .powerful-title-section {
             font-size: 1.6rem;
             font-weight: 900;
             margin-top: 2rem;
             margin-bottom: 0.75rem;
             color: var(--primary-color);
             border-bottom: 3px solid #6ee7b7; 
             padding-bottom: 0.25rem;
        }
        .title-card {
            padding: 1rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
        }
        .title-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .title-badge-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .title-index {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            font-weight: 800;
            text-align: center;
            font-size: 0.9rem;
            flex-shrink: 0;
            margin-right: 0.5rem;
        }
        .title-type-tag, .title-length-tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-weight: 700;
            text-align: center;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .title-type-tag {
            margin-right: 0.5rem;
        }
        .title-length-tag {
            background-color: #d1d5db; 
            color: #374151;
        }
        .title-text-content {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.5;
            white-space: normal;
            flex-grow: 1;
        }
        .news-content {
            line-height: 2; /* å¢åŠ è¡Œè·ï¼Œé©åˆé–±è®€ */
            text-align: justify;
            text-indent: 2em; /* é¦–è¡Œç¸®æ’ */
            margin-bottom: 1.25rem; /* æ®µè½é–“è· */
        }
        /* è­¦èªå€å¡Šï¼šç¾åœ¨ä½æ–¼æ–‡ç« æœ€æœ«ï¼Œéœ€è¦ä¸€å€‹æ˜é¡¯ä½†éä¾µå…¥æ€§çš„æ¨£å¼ */
        .disclaimer-text {
            font-size: 0.875rem;
            color: #7f1d1d; /* æ·±ç´…è‰²ï¼Œè­¦ç¤ºè‰² */
            background-color: #fef2f2; /* æ¥µæ·ºç´…è‰²èƒŒæ™¯ */
            border-left: 4px solid #f87171; /* å·¦å´ç´…è‰²é‚Šç·š */
            padding: 0.75rem 1rem;
            margin-top: 1.5rem; /* å¢åŠ èˆ‡æ­£æ–‡çš„å€éš” */
            margin-bottom: 0;
            border-radius: 0.375rem;
            line-height: 1.6;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="mb-8 p-6 bg-white rounded-xl shadow-2xl border-t-8 border-t-teal-600">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
                ğŸš€ è¶…ç´šæ–°èäººç¾¤ç¾¤ä¸‰ä»£
            </h1>
            <p class="text-gray-600 mt-3 font-medium">
                å°ˆç‚ºã€Šä¸‰ç«‹ã€‹èˆ‡ã€ŠETtodayã€‹é¢¨æ ¼ã€è¨˜è€…è”¡ç¶­æ­†/ç”°æšç‘‹æ¨¡å¼å®šåˆ¶çš„å°ˆæ¥­å…§å®¹ç”Ÿæˆèˆ‡å¼·åŒ–å¼•æ“ (V3.2 - çµæ§‹åŠ å›ºç‰ˆ)ã€‚
            </p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b mb-6 bg-white rounded-t-xl shadow-lg overflow-x-auto">
            <div id="tab-news" class="tab-button active" data-mode="news" onclick="handleTabSwitch('news')">ä¸€ã€é‡é»è½‰æ–°è</div>
            <div id="tab-rewrite_link" class="tab-button" data-mode="rewrite_link" onclick="handleTabSwitch('rewrite_link')">äºŒã€æ–°èæ”¹å¯« (30% å¼•ç”¨é™åˆ¶)</div>
            <div id="tab-rewrite_pr" class="tab-button" data-mode="rewrite_pr" onclick="handleTabSwitch('rewrite_pr')">ä¸‰ã€é€šç¨¿æ”¹å¯« (å…¨æ–‡ç…§ç™»è¨±å¯)</div>
            <div id="tab-interview" class="tab-button" data-mode="interview" onclick="handleTabSwitch('interview')">å››ã€è¨ªç¶±ç”Ÿæˆ (20 é¡Œæ·±åº¦è¿½å•)</div>
        </div>

        <!-- Main Content Area -->
        <div class="space-y-6">

            <!-- Dynamic Input Area -->
            <div id="inputViewContainer" class="p-6 bg-white rounded-xl shadow-2xl min-h-[300px] flex flex-col">
                <!-- Content will be injected here by JS -->
            </div>

            <!-- Results Display - ç§»é™¤æœ€å¤–å±¤çš„ç°è‰²åº•æ¡†ï¼Œè®“å…§å®¹æ›´ä¹¾æ·¨ -->
            <div id="resultContainer" class="p-6 bg-white rounded-xl shadow-2xl border border-gray-200 min-h-[150px]">
                <div id="loadingIndicator" class="hidden flex justify-center items-center h-full py-10">
                    <div class="loader"></div>
                    <span id="loadingMessage" class="ml-4 text-gray-600">æ­£åœ¨åŠªåŠ›ç”Ÿæˆå…§å®¹ä¸­...</span>
                </div>
                <div id="results" class="result-card text-gray-800">
                    <p class="text-center text-gray-500 py-10">è«‹é¸æ“‡åŠŸèƒ½ã€å¡«å¯« API Key ä¸¦è¼¸å…¥å…§å®¹ä»¥é–‹å§‹ç”Ÿæˆã€‚</p>
                </div>
            </div>
            
            <!-- Citation Display -->
            <div id="citationContainer" class="hidden p-4 bg-gray-100 rounded-lg border border-gray-300">
                <p class="font-semibold text-sm mb-2 text-gray-700">è³‡æ–™ä¾†æº (Grounding Sources):</p>
                <ul id="citationList" class="text-xs text-gray-600 list-disc pl-5 space-y-1"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        // ğŸš¨ ã€é‡è¦ã€‘è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Google Gemini API Key
        // å¦‚æœæ‚¨åœ¨ Canvas ç’°å¢ƒä¸­é‹è¡Œï¼Œè«‹ä¿æŒç‚ºç©º
        const globalApiKey = ""; 

        // API URL
        const apiUrlBase = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;

        // DOM å…ƒç´ 
        const inputViewContainer = document.getElementById('inputViewContainer');
        const resultsDiv = document.getElementById('results');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingMessage = document.getElementById('loadingMessage');
        const citationContainer = document.getElementById('citationContainer');
        const citationList = document.getElementById('citationList');
        const tabButtons = document.querySelectorAll('.tab-button');
        
        let currentMode = 'news';
        let isProcessing = false;

        // --- è¼¸å…¥ä»‹é¢æ¨¡æ¿ ---
        const inputTemplates = {
            news: {
                title: 'ä¸€ã€é‡é»è½‰æ–°èï¼šè¼¸å…¥äº‹ä»¶é‡é»æˆ–ç¤¾ç¾¤è²¼æ–‡',
                placeholder: 'è«‹è²¼ä¸Šæ‚¨æƒ³è½‰åŒ–ç‚ºæ–°èç¨¿çš„äº‹ä»¶æ¦‚è¦ã€è¨è«–ä¸²æˆ–è²¼æ–‡...',
                id: 'newsInput',
                buttonText: 'ğŸ“° ç”Ÿæˆã€Šä¸‰ç«‹/ETã€‹é¢¨æ ¼æ–°è',
                buttonClass: 'bg-teal-700 hover:bg-teal-800 focus:ring-teal-300',
                options: true,
                hasGrounding: true
            },
            rewrite_link: {
                title: 'äºŒã€æ–°èæ”¹å¯« (30% å¼•ç”¨é™åˆ¶)',
                placeholder: 'è«‹è²¼ä¸Šè¦æ”¹å¯«çš„ã€Œæ–°èå…¨æ–‡ã€æˆ–ã€Œæ–°èé€£çµï¼ˆURLï¼‰ã€ã€‚',
                id: 'rewriteLinkInput', 
                buttonText: 'ğŸ”— é–‹å§‹æ”¹å¯«ä¸¦è£œè¶³ 70% å…§å®¹',
                buttonClass: 'bg-indigo-700 hover:bg-indigo-800 focus:ring-indigo-300',
                options: false, 
                hasGrounding: true
            },
            rewrite_pr: {
                title: 'ä¸‰ã€é€šç¨¿æ”¹å¯« (å…¨æ–‡ç…§ç™»è¨±å¯)',
                placeholder: 'è«‹è²¼ä¸Šå…¬é—œæä¾›çš„æ–°èç¨¿ä»¶å…§å®¹...',
                id: 'prInput',
                buttonText: 'ğŸ“ é †ç¨¿æ•´ç†ä¸¦ç”Ÿæˆæ–°è',
                buttonClass: 'bg-amber-700 hover:bg-amber-800 focus:ring-amber-300',
                options: true,
                hasGrounding: false
            },
            interview: {
                title: 'å››ã€è¨ªç¶±ç”Ÿæˆ (20 é¡Œæ·±åº¦è¿½å•)',
                placeholder: 'è«‹è¼¸å…¥è—äººåå–® (ä¾‹å¦‚ï¼šå‘¨æ°å€«ã€è”¡ä¾æ—, æˆ–å–®ä¸€è—äºº)ï¼Œé¸å¡«è¨ªå•é‡é»...',
                id: 'artistInput',
                buttonText: 'ğŸ¤ æœå°‹äº‹ä»¶ä¸¦ç”Ÿæˆ 20 é¡Œè¨ªç¶±',
                buttonClass: 'bg-purple-700 hover:bg-purple-800 focus:ring-purple-300',
                options: false,
                hasGrounding: true
            }
        };

        // --- Tab åˆ‡æ›é‚è¼¯ ---
        window.handleTabSwitch = function(mode) {
            currentMode = mode;
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            renderInputView(mode);
            resultsDiv.innerHTML = '<p class="text-center text-gray-500 py-10">å·²åˆ‡æ›æ¨¡å¼ï¼Œè«‹ç¢ºèª API Key ä¸¦è¼¸å…¥å…§å®¹é–‹å§‹ç”Ÿæˆã€‚</p>';
            citationContainer.classList.add('hidden');
        }

        // --- æ¸²æŸ“è¼¸å…¥ä»‹é¢ ---
        function renderInputView(mode) {
            const template = inputTemplates[mode];
            
            // 1. API Key Input (Common to all modes)
            const apiKeyInputHtml = `
                <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                    <label for="localApiKey" class="block text-sm font-bold text-red-700 mb-2 flex items-center">
                        ğŸ”‘ API Key å¡«å¯«å€ (å¿…å¡«)
                        <span class="ml-2 text-xs font-normal text-red-500">(è‹¥åœ¨ Canvas ç’°å¢ƒä¸­é‹è¡Œï¼Œè«‹ä¿æŒç‚ºç©º)</span>
                    </label>
                    <input type="password" id="localApiKey" class="w-full p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Google Gemini API Key" value="${globalApiKey}">
                </div>
            `;
            
            // 2. Source Input for Mode 2 (rewrite_link)
            let mode2Inputs = '';
            let mainInputHtml = '';

            if (mode === 'rewrite_link') {
                mode2Inputs = `
                    <div class="mt-4">
                        <label for="sourceName" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“¢ ä¾†æºåª’é«”åç¨± (ä¾‹å¦‚ï¼šä¸‰ç«‹æ–°èç¶²ã€é¡é€±åˆŠ)</label>
                        <input type="text" id="sourceName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="è«‹å¡«å…¥åŸå§‹æ–°èåª’é«”åç¨±">
                    </div>
                    <div class="mt-4">
                        <label for="rewriteLinkInput" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ æ–°èå…¨æ–‡æˆ–é€£çµ</label>
                        <textarea id="rewriteLinkInput" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="${template.placeholder}"></textarea>
                    </div>
                `;
            } else {
                 // 3. Main Input (Textarea for other modes)
                mainInputHtml = `
                    <label for="${template.id}" class="block text-sm font-medium text-gray-700 mb-1">${template.title.split('ï¼š')[1] || 'ä¸»è¦è¼¸å…¥å€'}</label>
                    <textarea id="${template.id}" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150" placeholder="${template.placeholder}"></textarea>
                `;
            }

            // 4. Options for Modes 1 and 3 (Paragraph Count Selection)
            let optionsHtml = '';
            if (template.options) {
                optionsHtml = `
                    <div class="flex space-x-4 mt-4">
                        <div class="flex-1">
                            <label for="paragraphCount" class="block text-sm font-medium text-gray-700 mb-1">âœ… é¸æ“‡ç¸½æ®µè½æ•¸ (P1 + N æ®µ)</label>
                            <select id="paragraphCount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <option value="3">3 æ®µ (ç´„ 400-500 å­—)</option>
                                <option value="4" selected>4 æ®µ (ç´„ 600-750 å­—) - æ¨™æº–</option>
                                <option value="5">5 æ®µ (ç´„ 750-950 å­—)</option>
                                <option value="7">7 æ®µ (ç´„ 1100-1400 å­—) - é•·ç¯‡</option>
                            </select>
                        </div>
                    </div>
                `;
            }
            
            inputViewContainer.innerHTML = `
                ${apiKeyInputHtml}
                <h2 class="text-xl font-bold mb-4 text-gray-900">${template.title}</h2>
                ${mode2Inputs || mainInputHtml}
                ${optionsHtml}
                <button onclick="generateContent('${mode}')" id="actionButton" class="w-full mt-6 text-white font-bold py-3 rounded-lg transition duration-200 focus:outline-none focus:ring-4 ${template.buttonClass}">
                    ${template.buttonText}
                </button>
            `;
        }


        // --- API å‘¼å«èˆ‡é‡è©¦é‚è¼¯ ---
        async function fetchWithRetry(url, options, maxRetries = 7, delay = 2000) { 
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    // è™•ç† 429/503 (æµé‡é™åˆ¶/ä¼ºæœå™¨å¿™ç¢Œ)
                    if (response.status !== 429 && response.status !== 503) {
                        return response;
                    }
                } catch (error) {
                    // è™•ç†ç¶²è·¯éŒ¯èª¤ (ä¾‹å¦‚é€£ç·šä¸­æ–·)
                    if (i === maxRetries - 1) throw error; 
                }
                const waitTime = delay * Math.pow(2, i);
                console.log(`[API Retry] Retrying in ${waitTime / 1000}s. Attempt ${i + 2}/${maxRetries}.`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            throw new Error('API è«‹æ±‚åœ¨ 7 æ¬¡é‡è©¦å¾Œä»å¤±æ•—ã€‚éŒ¯èª¤: ä¼ºæœå™¨å¿™ç¢Œ (503) æˆ–æµé‡é™åˆ¶ (429)ã€‚');
        }

        // --- ä¸»è¦å…§å®¹ç”Ÿæˆå‡½æ•¸ ---
        window.generateContent = async function(mode) {
            const button = document.getElementById('actionButton');
            const localApiKeyInput = document.getElementById('localApiKey');
            const currentApiKey = localApiKeyInput.value.trim() || globalApiKey;

            // 0. å•Ÿç”¨ isProcessing æ——æ¨™ä¸¦æª¢æŸ¥ç‹€æ…‹ (é˜²æ­¢é€£é»é–å®š)
            if (isProcessing) return;
            isProcessing = true; 

            // 0. API Key æª¢æŸ¥
            if (!currentApiKey) {
                displayError('ğŸš¨ è‡´å‘½éŒ¯èª¤ï¼šAPI Key ç‚ºç©ºï¼è«‹æª¢æŸ¥ä¸¦å¡«å…¥æ‚¨çš„é‡‘é‘°ã€‚');
                isProcessing = false; 
                return;
            }
            const fullApiUrl = apiUrlBase + currentApiKey;


            let inputContent = '';
            let sourceName = '';
            let paragraphCount = 4;
            let systemInstruction = '';
            let payload = {};
            const template = inputTemplates[mode];
            let isGroundingEnabled = template.hasGrounding;

            // 1. ç²å–ä¸¦é©—è­‰æ‰€æœ‰è¼¸å…¥å’Œé¸é …
            try {
                if (mode === 'rewrite_link') {
                    // æ¨¡å¼ 2 åš´æ ¼é©—è­‰
                    inputContent = document.getElementById('rewriteLinkInput').value.trim();
                    sourceName = document.getElementById('sourceName').value.trim();
                    
                    if (!sourceName) { throw new Error('ä¾†æºåª’é«”åç¨±ç‚ºå¿…å¡«æ¬„ä½ã€‚'); }
                    if (!inputContent) { throw new Error('æ–°èå…¨æ–‡æˆ–é€£çµç‚ºå¿…å¡«æ¬„ä½ã€‚'); }
                } else {
                    // å…¶ä»–æ¨¡å¼é€šç”¨é©—è­‰
                    const elementId = template.id;
                    inputContent = document.getElementById(elementId).value.trim();
                    if (!inputContent) { throw new Error('è¼¸å…¥å…§å®¹ç‚ºç©ºã€‚'); }
                }

                if (template.options) {
                    paragraphCount = document.getElementById('paragraphCount').value;
                }
            } catch(e) {
                // è™•ç†è¼¸å…¥é©—è­‰éŒ¯èª¤
                displayError(`ğŸš¨ è¼¸å…¥éŒ¯èª¤ï¼š${e.message}`);
                // ç¢ºä¿ UI ç‹€æ…‹åœ¨è¼¸å…¥éŒ¯èª¤æ™‚ä¹Ÿè¢«æ¢å¾©
                isProcessing = false;
                if (button) {
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                    button.textContent = template.buttonText;
                }
                return;
            }

            // 2. æ ¹æ“šæ¨¡å¼è¨­å®šæç¤ºå’Œåƒæ•¸
            const sharedInstruction = `ä½ æ˜¯å°ˆæ¥­çš„å¨›æ¨‚æ–°èç·¨è¼¯ï¼Œæ’°ç¨¿é¢¨æ ¼å¿…é ˆæ¨¡ä»¿ã€Šä¸‰ç«‹ã€‹èˆ‡ã€ŠETtodayã€‹çš„ç­†æ³•ï¼Œä¸¦åƒç…§è¨˜è€…è”¡ç¶­æ­†ã€ç”°æšç‘‹çš„æ¨¡å¼ï¼šèªæ°£ç”Ÿå‹•ã€ç¯€å¥æ˜å¿«ã€å¤§é‡ä½¿ç”¨å•è™Ÿæˆ–é©šå˜†è©ã€å…§å®¹å…·å‚™è¡æ“Šæ€§ã€‚

            **æ¨™é¡ŒåŠ›é“ (Title Strength):** ä½ çš„æ¨™é¡Œå¿…é ˆæ˜¯ã€Œæµé‡çˆ†ç™¼å‹ã€æ¨™é¡Œã€‚æ¨™é¡Œè«‹æ¥µåº¦å„ªåŒ–ï¼Œå¿…é ˆæ›´å¸ç›ã€æ›´å…·çˆ†ç™¼åŠ›ï¼ŒåŒæ™‚é¿å…éåº¦æµ®èª‡ï¼Œåƒç…§ã€ŠETtodayæ˜Ÿå…‰é›²ã€‹ç­‰ç¶²åª’çš„å°ˆæ¥­å¯«æ³•ã€‚

            **å…§å®¹è¦ç¯„ (Content Rules):**
            1. ç¸½æ®µè½æ•¸ï¼š**${paragraphCount}** æ®µã€‚
            2. é¦–æ®µå­—æ•¸ï¼š**ä¸è¶…é 140 å­—**ã€‚
            3. **åš´ç¦è¼¸å‡ºå­—æ•¸ï¼š** å…§å®¹ä¸­**çµ•å°ä¸å¯ä»¥**å‡ºç¾ä»»ä½•å½¢å¼çš„å­—æ•¸çµ±è¨ˆï¼Œå¦‚ï¼š(187å­—)ã€(200 WORDS) ç­‰ã€‚
            4. **æ¨™é¡Œæ¨™é»ç¬¦è™Ÿç¦ä»¤ï¼š** æ‰€æœ‰çš„å…­å€‹æ¨™é¡Œä¸­ï¼Œ**çµ•å°ä¸å¯ä»¥**åŒ…å«ã€Œï¼Œã€èˆ‡ã€Œã€‚ã€é€™å…©ç¨®æ¨™é»ç¬¦è™Ÿã€‚
            5. **å…¬ç‰ˆè­¦èªæ¤å…¥ (Mandatory)**ï¼šè«‹æ ¹æ“šå…§æ–‡æ¶‰åŠçš„ä¸»é¡Œï¼ˆå¦‚ï¼šé£²é…’ã€æ¯’å“ã€è‡ªæ®ºã€å¸è¸ï¼‰æ™ºæ…§åˆ¤æ–·å‡º**æ‰€æœ‰ç›¸é—œè­¦èª**ï¼Œä¸¦å°‡å®ƒå€‘**å…¨éƒ¨é›†ä¸­**æ”¾åœ¨æ–°èç¨¿å…§å®¹çš„**æœ€æœ«ç«¯**ï¼Œä»¥ç©ºè¡Œéš”é–‹ï¼Œè€Œä¸æ˜¯åµŒå…¥æ–‡ç« ä¸­ã€‚**åªæ’å…¥ç›¸é—œçš„è­¦èª**ï¼š
               - ã€ŠETtodayæ–°èé›²ã€‹æé†’æ‚¨ï¼Œè«‹çµ¦è‡ªå·±æ©Ÿæœƒï¼šè‡ªæ®ºé˜²æ²»è«®è©¢å®‰å¿ƒå°ˆç·šï¼š1925ï¼›ç”Ÿå‘½ç·šå”è«‡å°ˆç·šï¼š1995
               - ã€ŠETtodayæ–°èé›²ã€‹æé†’æ‚¨ï¼šå–é…’ä¸é–‹è»Šï¼Œé–‹è»Šä¸å–é…’ã€‚
               - ã€ŠETtodayæ–°èé›²ã€‹æé†’æ‚¨ï¼šå¸è¸æœ‰å®³å¥åº·ï¼
               - ã€ŠETtodayæ–°èé›²ã€‹æé†’æ‚¨ï¼Œä¿è­·è‡ªå·±ã€é é›¢æ¯’å“ï¼
            
            **ã€çµæ§‹è¼¸å‡ºå¼·åˆ¶è¦æ±‚ã€‘(MANDATORY OUTPUT FORMAT):**
            ä½ çš„è¼¸å‡ºå¿…é ˆ**åš´æ ¼**æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ï¼Œ**ä¸èƒ½**åœ¨ç¬¬ä¸€å€‹æ¨™è¨˜å‰æœ‰ä»»ä½•é¡å¤–æ–‡å­—ï¼Œä¸”å¿…é ˆåŒæ™‚åŒ…å«é€™å…©å€‹å€å¡Šï¼š

            ### æ¨™é¡Œåˆ—è¡¨ (Title List)
            1. æ¨™æº–æµé‡æ¨™é¡Œ (é•·æ¨™, 25å­—å…§): 
            2. æ¨™æº–æµé‡æ¨™é¡Œ (çŸ­æ¨™, 15å­—è‡³20å­—): 
            3. è—æ¨™å‹æ¨™é¡Œ (é•·æ¨™, 25å­—å…§): æ¨™é¡Œå¸¶æœ‰æ‡¸å¿µï¼Œä¸å®Œå…¨é€éœ²äº‹ä»¶çµæœã€‚
            4. è—æ¨™å‹æ¨™é¡Œ (çŸ­æ¨™, 15å­—è‡³20å­—): æ¨™é¡Œå¸¶æœ‰æ‡¸å¿µï¼Œä¸å®Œå…¨é€éœ²äº‹ä»¶çµæœã€‚
            5. ç‰¹æ®Šå‹æ¨™é¡Œ (é•·æ¨™, 25å­—å…§): æ¨™é¡Œä½¿ç”¨è«§éŸ³ã€æ¢—æˆ–æµè¡Œèªç­‰ç‰¹æ®Šæ‰‹æ³•ã€‚
            6. ç‰¹æ®Šå‹æ¨™é¡Œ (çŸ­æ¨™, 15å­—è‡³20å­—): æ¨™é¡Œä½¿ç”¨è«§éŸ³ã€æ¢—æˆ–æµè¡Œèªç­‰ç‰¹æ®Šæ‰‹æ³•ã€‚

            ### æ–°èç¨¿å…§å®¹ (News Content)
            è«‹æ’°å¯«ä¸€ç¯‡å®Œæ•´ã€å°ˆæ¥­ä¸”ç¬¦åˆä¸Šè¿°å­—æ•¸é™åˆ¶çš„æ–°èç¨¿ï¼Œä¸¦å°‡ç›¸é—œè­¦èªé›†ä¸­æ”¾åœ¨æ–‡ç« æœ€æœ«è™•ã€‚
            `;


            switch(mode) {
                case 'news':
                    loadingMessage.textContent = 'æ­£åœ¨ä»¥ã€Šä¸‰ç«‹/ETtodayã€‹é¢¨æ ¼ç”Ÿæˆæ–°èèˆ‡å…­æ¨™é¡Œ...';
                    systemInstruction = sharedInstruction;
                    payload = { contents: [{ parts: [{ text: inputContent }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
                    break;
                
                case 'rewrite_pr':
                    loadingMessage.textContent = 'æ­£åœ¨æ•´ç†å…¬é—œç¨¿ï¼Œé‡æ–°ç·¨æ’ä¸¦ç”Ÿæˆå…­æ¨™é¡Œ (å…è¨±å…¨æ–‡ç…§ç™»)...';
                    systemInstruction = sharedInstruction.replace('è«‹æ’°å¯«ä¸€ç¯‡å®Œæ•´ã€å°ˆæ¥­ä¸”ç¬¦åˆä¸Šè¿°å­—æ•¸é™åˆ¶çš„æ–°èç¨¿', `ã€é‡è¦ã€‘è‹¥å…¬é—œç¨¿å…§å®¹æ¥µç‚ºå®Œæ•´ï¼Œå…è¨±æ‚¨å…¨æ–‡ç…§ç™»ï¼Œä½†ä»éœ€é‡æ–°ç·¨æ’æ®µè½ã€å°‡è­¦èªé›†ä¸­æ–¼æ–‡æœ«ã€‚è«‹æ’°å¯«ä¸€ç¯‡å®Œæ•´ã€å°ˆæ¥­ä¸”ç¬¦åˆä¸Šè¿°å­—æ•¸é™åˆ¶çš„æ–°èç¨¿`);
                    payload = { contents: [{ parts: [{ text: inputContent }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
                    break;

                case 'rewrite_link':
                    loadingMessage.textContent = 'æ­£åœ¨æ”¹å¯«æ–°èï¼Œä¸¦ä»¥ Grounding æœå°‹å…§å®¹å¡«è£œ 70% è³‡è¨Š...';
                    systemInstruction = sharedInstruction.replace('è«‹æ’°å¯«ä¸€ç¯‡å®Œæ•´ã€å°ˆæ¥­ä¸”ç¬¦åˆä¸Šè¿°å­—æ•¸é™åˆ¶çš„æ–°èç¨¿', `
                    **æ”¹å¯«è¦ç¯„ (Rewrite Rules):**
                    1. å…§å®¹æ›¿æ›ï¼šæ”¹å¯«å…§å®¹**ä¸å¯å»¶ç”¨**åŸå§‹æ–°è**é€£çºŒ 15 å­—ä»¥ä¸Š**ã€‚
                    2. å…§å®¹è£œè¶³ (æ ¸å¿ƒ)ï¼š**å¿…é ˆ**åˆ©ç”¨å·²çŸ¥æ–°èèˆ‡äº‹ä»¶ï¼ˆé€é Grounding æœå°‹ï¼‰ä¾†å¡«è£œæˆ–å»¶ä¼¸ï¼Œç¢ºä¿æ”¹å¯«å…§å®¹ä¸­æœ‰ **70%** æ˜¯å…¨æ–°çš„è³‡è¨Šæˆ–è§€é»ï¼Œè€Œ**åƒ… 30%** ä¾†è‡ªåŸå§‹æ–°èçš„é‡é»å…§å®¹ã€‚
                    3. å°Šé‡åª’é«”ï¼šæ–°èç¨¿å…§å®¹çš„ç¬¬äºŒæ®µé¦–å¥å¿…é ˆè‘—åã€Œæ ¹æ“š${sourceName}å ±å°...ã€æˆ–é¡ä¼¼èªå¥ã€‚

                    è«‹æ’°å¯«ä¸€ç¯‡å®Œæ•´ã€å°ˆæ¥­ä¸”ç¬¦åˆä¸Šè¿°å­—æ•¸é™åˆ¶çš„æ–°èç¨¿`);
                    const rewritePrompt = `ã€åŸå§‹ä¾†æºåç¨±ã€‘ï¼š${sourceName}\n\nã€åŸå§‹æ–°èå…§å®¹ã€‘ï¼š\n${inputContent}\n\nè«‹æ ¹æ“šç³»çµ±æŒ‡ç¤ºï¼Œæ”¹å¯«ä»¥ä¸Šå…§å®¹ã€‚`;
                    payload = { contents: [{ parts: [{ text: rewritePrompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
                    break;
                
                case 'interview':
                    // è¨ªç¶±æ¨¡å¼ä¸éœ€è¦æ®µè½/å­—æ•¸é™åˆ¶æˆ–è­¦èªï¼Œä½¿ç”¨ç°¡æ½” instruction
                    loadingMessage.textContent = `æ­£åœ¨æœå°‹è—äººã€Œ${inputContent}ã€çš„è¿‘æœŸäº‹ä»¶ï¼Œæº–å‚™ 20 é¡Œæ·±åº¦è¨ªç¶±...`;
                    systemInstruction = `ä½ æ˜¯ç¶“é©—è±å¯Œçš„å¨›æ¨‚ç¯€ç›®è£½ä½œäººå’Œè¨ªè«‡å°ˆå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„è—äººåå–®ï¼ˆ${inputContent}ï¼‰åŠå…¶æ‰€æœ‰è¿‘æœŸçš„äº‹ä»¶ï¼ˆçˆ­è­°ã€è² é¢ã€æ­£é¢ã€æ–°ä½œå“ã€é–‹åº—ç­‰ï¼‰ç”Ÿæˆä¸€ä»½åŒ…å«**ç²¾ç¢º 20 é¡Œ**å•é¡Œçš„è¨ªç¶±ã€‚è¨ªç¶±å¿…é ˆæ¶µè“‹æ‰€æœ‰é—œéµè©±é¡Œï¼Œå•é¡Œæ‡‰å…·å‚™æ·±åº¦å’Œæ–°èæ€§ã€‚

                    è¼¸å‡ºæ ¼å¼ï¼šè«‹ç”¨ä¸­æ–‡ä»¥ Markdown **æœ‰åºåˆ—è¡¨ (1. 2. 3...)** æ ¼å¼è¼¸å‡ºé€™ 20 å€‹å•é¡Œï¼Œ**ä¸éœ€ä»»ä½•æ¨™é¡Œæˆ–é¡å¤–æ–‡å­—**ã€‚
                    `;
                    const interviewPrompt = `è«‹æ ¹æ“šæ‚¨æ‰¾åˆ°çš„é—œæ–¼è—äººã€Œ${inputContent}ã€çš„æ‰€æœ‰è¿‘æœŸäº‹ä»¶èˆ‡æ–°èï¼Œç”Ÿæˆä¸€ä»½å…± 20 å€‹å•é¡Œçš„å®Œæ•´è¨ªç¶±ã€‚`;
                    payload = { contents: [{ parts: [{ text: interviewPrompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
                    break;
            }

            // å•Ÿç”¨ Grounding Tool
            if (isGroundingEnabled) {
                 payload.tools = [{ "google_search": {} }];
            }

            // 3. UI ç‹€æ…‹åˆ‡æ›
            resultsDiv.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            citationContainer.classList.add('hidden');
            
            if (button) {
                button.disabled = true;
                button.classList.add('opacity-50');
                button.textContent = 'è™•ç†ä¸­... è«‹ç¨å€™';
            }


            try {
                // 4. API å‘¼å«
                const response = await fetchWithRetry(fullApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                // 5. è§£æçµæœ
                const candidate = result.candidates?.[0];
                let generatedText = "ç„¡æ³•å–å¾—å…§å®¹ã€‚";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;

                    // æå–ä¾†æº (å¦‚æœä½¿ç”¨ Grounding)
                    if (isGroundingEnabled) {
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                    }
                } else if (result.error) {
                    generatedText = `API éŒ¯èª¤: ${result.error.message} (éŒ¯èª¤ç¢¼: ${response.status})ã€‚è«‹æª¢æŸ¥ Console å°‹æ‰¾æ›´å¤šç´°ç¯€ã€‚`;
                    console.error("API Error Response:", result);
                } else {
                    generatedText = "ç”Ÿæˆå…§å®¹çš„çµæ§‹ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚";
                }

                // 6. é¡¯ç¤ºçµæœå’Œä¾†æº
                displayResults(generatedText, sources, mode);

            } catch (error) {
                // è™•ç†ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ– fetchWithRetry æ‹‹å‡ºçš„æœ€çµ‚éŒ¯èª¤
                displayError(`ğŸš¨ ç™¼ç”Ÿåš´é‡ç¶²è·¯éŒ¯èª¤æˆ–é™æµéŒ¯èª¤: ${error.message}ã€‚`);
                console.error("Fetch/Retry Error:", error);
            } finally {
                // 7. ã€å¼·åˆ¶é‡è¨­ã€‘ç¢ºä¿ UI ç‹€æ…‹åœ¨æ‰€æœ‰æƒ…æ³ä¸‹éƒ½è¢«æ¢å¾©ï¼Œé˜²æ­¢è½‰åœˆåœˆé–å®š
                isProcessing = false;
                loadingIndicator.classList.add('hidden');
                if (button) {
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                    button.textContent = template.buttonText;
                }
            }
        }

        // --- é¡¯ç¤ºçµæœå’ŒéŒ¯èª¤ (åŠ å›ºå¾Œçš„æ¨™é¡Œè§£æé‚è¼¯) ---
        function displayResults(text, sources, mode) {
            
            // ğŸš¨ ã€å¼·åˆ¶ç§»é™¤å­—æ•¸ã€‘: å¼·åˆ¶ç§»é™¤æ‰€æœ‰å¯èƒ½çš„å­—æ•¸æ¨™è¨» (XXXå­—)
            text = text.replace(/\(\d+[\s]*å­—\)/g, '').trim(); 
            text = text.replace(/\(\d+[\s]*WORDS\)/g, '').trim(); 
            text = text.replace(/---\s*$/gm, '').trim(); // ç§»é™¤å¯èƒ½çš„å†—é¤˜åˆ†éš”ç¬¦
            
            // è™•ç†é€šç”¨ Markdown ç²—é«”
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            let htmlContent = '';
            
            if (mode === 'news' || mode === 'rewrite_link' || mode === 'rewrite_pr') {
                
                // ğŸš€ V3.2 çµæ§‹è§£æå¼·åŒ–ï¼šä½¿ç”¨ Regex ç©©å¥æå–æ¨™é¡Œå€å’Œå…§æ–‡å€ï¼Œé¿å…å›  LLM è¼¸å‡ºå†—é¤˜æ–‡å­—æˆ–æ¨™è¨˜è®Šå‹•å°è‡´è§£æå¤±æ•—
                // æ¨™é¡Œåˆ—è¡¨å€å¡Šï¼šå¾ '### æ¨™é¡Œåˆ—è¡¨' é–‹å§‹ï¼Œåˆ°ä¸‹ä¸€å€‹ '###' æ¨™è¨˜ç‚ºæ­¢ (éè²ªå©ªåŒ¹é…)
                const titleListRegex = /###\s*æ¨™é¡Œåˆ—è¡¨(?:\s*\(Title\s*List\))?\s*\n([\s\S]*?)\n*###/i;
                // æ–°èç¨¿å…§å®¹å€å¡Šï¼šå¾ '### æ–°èç¨¿å…§å®¹' é–‹å§‹ï¼Œåˆ°æ–‡æœ¬çµæŸç‚ºæ­¢
                const newsContentRegex = /###\s*æ–°èç¨¿å…§å®¹(?:\s*\(News\s*Content\))?\s*\n([\s\S]*)/i;

                const titleMatch = text.match(titleListRegex);
                const newsMatch = text.match(newsContentRegex);

                let titleListContent = titleMatch ? titleMatch[1].trim() : '';
                let newsContentBody = newsMatch ? newsMatch[1].trim() : '';
                
                let titlesHtml = '';
                
                if (titleListContent) {
                    
                    // ** æ¨™é¡Œè§£æä¿®æ­£ **ï¼šä½¿ç”¨æ›´å¼·å¥çš„ Regex åŒ¹é…é æœŸçš„çµæ§‹ "æ•¸å­—. é¡å‹ (æ¨™ç±¤): å…§å®¹"
                    const titleRegex = /(\d+\.\s*)(.+?)\s*\((\S+?)(?:,.*?)?\):\s*(.+?)\s*$/gm; 
                    
                    const parsedTitles = [];
                    let match;
                    while ((match = titleRegex.exec(titleListContent)) !== null) {
                        if (parsedTitles.length < 6) { 
                            let titleText = match[4].trim();

                            // ğŸš¨ ã€å¼·åˆ¶ç§»é™¤æ¨™é»ã€‘: ç§»é™¤æ¨™é¡Œä¸­çš„ã€Œï¼Œã€å’Œã€Œã€‚ã€
                            titleText = titleText.replace(/[ï¼Œã€‚]/g, '');

                            parsedTitles.push({
                                index: match[1].replace('.', '').trim(),
                                type: match[2].trim(),
                                text: titleText,
                                length: match[3].trim()
                            });
                        }
                    }

                    titlesHtml = parsedTitles.map((item, i) => {
                        let typeClass = 'bg-gray-200 text-gray-800'; 
                        
                        // æ ¹æ“šæ¨™é¡Œé¡å‹è¨­å®šé¡è‰²
                        if (item.type.includes('æ¨™æº–æµé‡æ¨™é¡Œ')) typeClass = 'bg-teal-100 text-teal-800';
                        else if (item.type.includes('è—æ¨™')) typeClass = 'bg-amber-100 text-amber-800';
                        else if (item.type.includes('ç‰¹æ®Šå‹æ¨™é¡Œ')) typeClass = 'bg-purple-100 text-purple-800';

                        // æ¨™é¡Œé•·åº¦æ¨™ç±¤èª¿æ•´ç‚ºæ›´æ˜ç¢ºçš„æè¿° (é•·æ¨™, 15-20å­—)
                        let lengthLabel = item.length;
                        if (lengthLabel.includes('é•·æ¨™')) {
                             lengthLabel = 'é•·æ¨™ (25å­—å…§)';
                        } else if (lengthLabel.includes('çŸ­æ¨™')) {
                             lengthLabel = 'çŸ­æ¨™ (15-20å­—)';
                        }


                        return `
                            <div class="title-card">
                                <div class="title-badge-container">
                                    <span class="title-index">${(i + 1)}</span> 
                                    <span class="title-type-tag ${typeClass}">${item.type.split('æ¨™é¡Œ')[0]}</span>
                                    <span class="title-length-tag">${lengthLabel}</span>
                                </div>
                                <p class="title-text-content">${item.text}</p>
                            </div>
                        `;
                    }).join('');
                    
                    // ç¶²æ ¼ä½ˆå±€ï¼šå›ºå®šå…©æ¬„
                    htmlContent += `
                        <h3 class="powerful-title-section">ğŸ“° æ¨™é¡Œåˆ—è¡¨ (Title List)</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            ${titlesHtml}
                        </div>
                    `;
                }
                
                let newsBodyHtml = '';
                if (newsContentBody) {
                    // 3. è™•ç† News Body: ä¾æ“šå…©æ¬¡ä»¥ä¸Šæ›è¡Œä¾†åˆ†å‰²æ®µè½ï¼Œä¸¦ç”¨ <p> æ¨™ç±¤åŒ…è£
                    const paragraphs = newsContentBody.trim().split(/\n\n+/).filter(p => p.trim() !== '');
                    
                    // ç”±æ–¼è­¦èªå·²è¦æ±‚æ”¾åœ¨æ–‡æœ«ï¼Œæˆ‘å€‘å°‡è­¦èªå¾ä¸»æ®µè½åˆ†é›¢
                    let bodyParagraphs = [];
                    let disclaimers = [];

                    paragraphs.forEach(p => {
                        const isDisclaimer = p.includes('ETtodayæ–°èé›²ã€‹æé†’æ‚¨');
                        if (isDisclaimer) {
                            disclaimers.push(p);
                        } else {
                            bodyParagraphs.push(p);
                        }
                    });

                    // è¼¸å‡ºæ–°èæ­£æ–‡
                    newsBodyHtml += bodyParagraphs.map(p => {
                        // ç¢ºä¿æ®µè½å…§çš„å–®æ¬¡æ›è¡Œè®Šæˆ <br>
                        const formattedParagraph = p.trim().replace(/\n/g, '<br>');
                        // é€™æ˜¯æ­£å¸¸æ–°èæ®µè½
                        return `<p class="news-content text-gray-700">${formattedParagraph}</p>`;
                    }).join('');

                    // è¼¸å‡ºè­¦èªå€å¡Š (User Request #3: è­¦èªå¾Œç½®)
                    if (disclaimers.length > 0) {
                        const disclaimerContent = disclaimers.join('<br>').trim().replace(/\n/g, '<br>'); // å°‡æ‰€æœ‰è­¦èªé›†ä¸­ä¸¦ç”¨ <br> åˆ†éš”
                         newsBodyHtml += `<div class="disclaimer-text">${disclaimerContent}</div>`;
                    }
                    
                    htmlContent += `
                        <h3 class="powerful-title-section">ğŸ“ æ–°èç¨¿å…§å®¹ (News Content)</h3>
                        <div class="space-y-3 mt-4 text-base">
                            ${newsBodyHtml}
                        </div>
                    `;
                } else {
                     // æ¨™é¡Œåˆ—è¡¨ä¸å­˜åœ¨ æˆ– å…§æ–‡ä¸å­˜åœ¨ï¼Œå‰‡é¡¯ç¤ºéŒ¯èª¤
                    htmlContent += `
                        <h3 class="powerful-title-section text-red-600">âš ï¸ å…§æ–‡çµæ§‹éŒ¯èª¤ (éŒ¯èª¤ä»£ç¢¼: NEWS_BODY_FAIL)</h3>
                        <div class="mt-4 p-4 bg-red-100 border border-red-300 rounded-lg whitespace-pre-wrap text-sm text-red-800">
                            æ¨¡å‹è¼¸å‡ºçš„å…§æ–‡å€å¡Šæœªèƒ½è¢«æ­£ç¢ºè§£æã€‚é€™é€šå¸¸ç™¼ç”Ÿæ–¼æ¨¡å‹ï¼š<br>
                            1. **éºæ¼**äº†ã€Œ### æ–°èç¨¿å…§å®¹ã€é€™å€‹æ¨™è¨˜ã€‚<br>
                            2. è¼¸å‡ºå…§å®¹èˆ‡çµæ§‹æŒ‡ä»¤åå·®éå¤§ã€‚<br><br>
                            è«‹å˜—è©¦**é‡æ–°ç”Ÿæˆ**ä¸€æ¬¡ï¼Œè‹¥ä»å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹æ˜¯å¦éæ–¼ç°¡çŸ­æˆ–æ¨¡ç³Šã€‚<br><br>
                            <strong>åŸå§‹è¼¸å‡ºé¦–éƒ¨ç‰‡æ®µï¼š</strong><br>
                            ${text.substring(0, 500)}
                        </div>
                    `;
                }
                
            } else if (mode === 'interview') {
                // Interview mode list logic
                const listItems = text.match(/(\d+\.\s+)(.*?)(\n|$)/g);
                
                if (listItems && listItems.length >= 10) { // ç¨å¾®æ”¾å¯¬ä¸€é»ï¼Œä½†æé†’
                    htmlContent += '<h3 class="powerful-title-section">ğŸ¤ æ·±åº¦è¨ªç¶±</h3>';
                    if (listItems.length !== 20) {
                        htmlContent += `<p class="text-sm text-amber-700 mb-4 font-semibold">âš ï¸ å¯¦éš›ç”Ÿæˆé¡Œæ•¸ç‚º ${listItems.length} é¡Œï¼Œæœªæ»¿ 20 é¡Œï¼Œè«‹å˜—è©¦é‡æ–°ç”Ÿæˆæˆ–å„ªåŒ–è¼¸å…¥ã€‚</p>`;
                    }
                    htmlContent += '<ol class="list-decimal list-inside space-y-3 pl-2 text-base">';
                    listItems.forEach(item => {
                        const cleanItem = item.replace(/(\d+\.\s+)/, '').trim();
                        htmlContent += `<li class="text-gray-700 font-medium">${cleanItem}</li>`;
                    });
                    htmlContent += '</ol>';
                } else {
                    htmlContent = '<h3 class="powerful-title-section text-red-600">âš ï¸ è¨ªç¶±ç”Ÿæˆå¤±æ•—</h3>';
                    htmlContent += `<p class="text-gray-500 italic">æœªèƒ½ç”Ÿæˆè¶³å¤ çš„è¨ªç¶±åˆ—è¡¨ï¼Œé€™æ˜¯åŸå§‹è¼¸å‡ºï¼š</p>` + `<div class="mt-4 p-4 bg-gray-100 rounded-lg whitespace-pre-wrap text-sm">${text}</div>`;
                }
            } else {
                // Default formatting for other modes
                htmlContent = text.replace(/\n/g, '<br>');
            }

            // ğŸš¨ ã€å»æ¡†åŒ–ã€‘: ç›´æ¥å°‡å…§å®¹å¯«å…¥ resultsDiv
            resultsDiv.innerHTML = htmlContent; 
            
            // é¡¯ç¤ºè³‡æ–™ä¾†æº
            if (sources.length > 0) {
                citationList.innerHTML = sources.map(source => 
                    `<li><a href="${source.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline transition">${source.title || 'ç„¡æ¨™é¡Œ'}</a></li>`
                ).join('');
                citationContainer.classList.remove('hidden');
            } else {
                citationContainer.classList.add('hidden');
            }
        }

        function displayError(message) {
            resultsDiv.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center font-medium">${message}</div>`;
            citationContainer.classList.add('hidden');
            
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            const button = document.getElementById('actionButton');
            const mode = currentMode; 
            if (button) {
                button.disabled = false;
                button.classList.remove('opacity-50');
                button.textContent = inputTemplates[mode].buttonText;
            }
            // ç¢ºä¿ isProcessing æ——æ¨™è¢«é‡è¨­
            isProcessing = false;
            loadingIndicator.classList.add('hidden');
        }

        // åˆå§‹åŒ–ï¼šé¦–æ¬¡è¼‰å…¥æ™‚æ¸²æŸ“é è¨­ä»‹é¢ (é‡é»è½‰æ–°è)
        document.addEventListener('DOMContentLoaded', () => {
            handleTabSwitch('news');
        });

    </script>
</body>
</html>